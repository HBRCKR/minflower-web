<script lang="ts">
    import type { PageData } from './$types.js';
    import type { BoardDetail } from '$lib/type/board/board.js';
    import { writable } from 'svelte/store';
	  import moment from 'moment';

    export let data: PageData;

    let boards = writable<BoardDetail[]>(data.boardPage.content);
</script>
<div class="fc_content content _content_body">
    <div class="fcdeck_container">
        <div class="fcdeck_ct">
            <div class="card" data-cid="4c92l851" data-anchor="a6deb04d249efff33c428e1d7d576cad" >
                <div class="main_area current" data-content-uri="/apps/board/entry" data-cid="4c92l851" data-anchor="a6deb04d249efff33c428e1d7d576cad" data-adult-flag="0" data-title="공지사항" id="modoo-wdq35z">
                    <div class="inner">
                      <div class="uio_box board_box">
                        <h3 class="uio_title theme_color type_block">
                            <span class="uio_title_bullet theme_background"></span>공지사항
                            <div class="search_result" data-role="board_result_count" style="display:none">
                            <div class="result _myList" style="display:none;"><span>내가 작성한 글</span><span class="theme_color" data-role="result_cnt">0</span>건</div>
                            <div class="result _searchList">'<span class="keyword _keyword"></span>'에 대한 <span>검색결과 <span class="theme_color" data-role="result_cnt">0</span>건</span></div>
                            <a href="#" class="nicon_before1 _btnPrev"><span class="blind">이전 페이지로</span></a>
                            </div>
                            <div class="pag_btn_area">
                              <div id="viewType" class="_viewType">
                                <a href="#" class="btn_type theme_color" data-type="list">
                                  <span class="icon nicon_all4 theme_color"></span>
                                  <span class="text">목록보기</span>
                                </a>
                                <a href="#" class="btn_type " data-type="card">
                                  <span class="icon nicon_all2 "></span>
                                  <span class="text">카드보기</span>
                                </a>
                                <!-- <a href="#" class="btn_type map " data-type="map">
                                  <span class="icon nicon_all5"></span>
                                  <span>매거진형</span>
                                </a> -->
                              </div>
                            </div>
                        </h3>
                        <div data-role="page-container" style="width:100%" class="uio_content  " data-ready-state="complete">
                          <div data-role="page-list" id="innerWrap" class="page_list">
                            <div class="table_area" data-role="board_view">
                              <div class="result_notice" data-role="board_list">
                                <table class="table_type1">
                                  <caption><span class="blind">자유게시판 목록</span></caption>
                                  <colgroup>
                                    <col style="width:52px;">								
                                    <col style="width:52px;">
                                    <col>
                                    <col style="width:120px;">
                                    <col style="width:129px;">
                                  </colgroup>
                                  <thead>
                                  <tr>
                                    <th scope="col"><input type="checkbox" class="_checkAll" id="check_all" title="전체선택"></th>
                                    <th scope="col">번호</th>
                                    <th scope="col">글제목</th>
                                    <th scope="col">글쓴이</th>
                                    <th scope="col">작성일</th>
                                  </tr>
                                  </thead>
                                  <tbody class="_boardContent">
                                    {#each $boards as board, index}
                                      <tr class="" data-message-no={`${$boards.length- index}`} data-login-id="mindflower2" data-is-old-secret-reply="0">
                                      <td>
                                        <input type="checkbox" class="_check" title="선택">
                                      </td>
                                      <td>
                                        <span class="index">{$boards.length- index}</span>
                                      </td>
                                      <td>
                                        <div class="area">
                                            <a href="/notice/{board.id}" class="tit">
                                              {board.title}
                                          </a>
                                        </div>
                                      </td>
                                      <td><span class="writer">{board.author}</span></td>
                                      <td><span class="date">{moment(board.createdAt).format('YYYY.MM.DD')}</span></td>
                                            </tr>
                                    {/each}
                                    <!--  -->
                                </tbody>                                
                        </table>
                              </div>
                            </div>
                            <div class="paginate _paginate" style=""><a href="#" class="prev _prev"><span class="icon nicon_backward2"><span class="blind">이전</span></span></a><a href="#" class="selected">1</a><a href="#" class="next _next"><span class="icon nicon_forward2"><span class="blind">다음</span></span></a></div>
                          </div>
                    
                    
                          <!-- 게시글이 없을 경우 메세지 -->
                          <script type="text/html" data-template-name="listNoData">
                            <tr>
                                        <td colspan="5" class="nodata">
                                <span class="icon nicon_write3"></span>
                                <strong class="title">등록된 글이 없습니다.</strong>
                              </td>
                            </tr>
                          </script>
                    
                          <script type="text/html" data-template-name="cardNoData">
                            <span class="icon nicon_write3"></span>
                            <strong class="title">등록된 글이 없습니다.</strong>
                          </script>
                    
                          <script type="text/html" data-template-name="listNoSearchData">
                            <tr>
                                        <td colspan="5" class="nodata">
                                <span class="icon nicon_m-warning1"><span class="blind">주의</span></span>
                                <strong class="title"><span class="keyword theme_color _keyword">키워드</span>에 대한 검색 결과가 없습니다</strong>
                                <p class="info">단어의 철자가 정확한지 확인한 후 다시 한번 검색 해주세요.</p>
                              </td>
                            </tr>
                          </script>
                    
                          <script type="text/html" data-template-name="cardNoSearchData">
                            <span class="icon nicon_m-warning1"><span class="blind">주의</span></span>
                                    <strong class="title"><span class="keyword theme_color _keyword">키워드</span>에 대한 검색 결과가 없습니다</strong>
                            <p class="info">단어의 철자가 정확한지 확인한 후 다시 한번 검색 해주세요.</p>
                          </script>
                    
                          <!-- template: 게시글 쓰기, 삭제, 리스트형, 카드형 버튼 -->
                          <script type="text/html" data-template-name="boardButtonForExternalDom">
                            <div class="pag_btn_area">
                              <div id="viewType" class="_viewType">
                                <a href="#" class="btn_type theme_color" data-type="list">
                                  <span class="icon nicon_all4 theme_color"></span>
                                  <span class="text">목록보기</span>
                                </a>
                                <a href="#" class="btn_type " data-type="card">
                                  <span class="icon nicon_all2 "></span>
                                  <span class="text">카드보기</span>
                                </a>
                                <!-- <a href="#" class="btn_type map " data-type="map">
                                  <span class="icon nicon_all5"></span>
                                  <span>매거진형</span>
                                </a> -->
                              </div>
                            </div>
                          </script>
                          <!-- // template: 게시글 쓰기, 삭제, 리스트형, 카드형 버튼 -->
                    
                          <!-- template: 게시물 리스트형 목록 -->
                          <script type="text/html" data-template-name="listMessage">
                            <tr class="[[#isTopNotice]]notice[[/isTopNotice]]" data-message-no="[[messageNo]]" data-login-id="[[loginId]]" data-is-old-secret-reply="[[isOldSecretReply]]">
                              <td>
                                <input type="checkbox" class="_check" title="선택">
                              </td>
                              <td>
                                [[#isTopNotice]]
                                <span class="icon nicon_sound3"><span class="blind">공지사항</span></span>
                                [[/isTopNotice]]
                                [[^isTopNotice]]
                                <span class="index">[[messageNo]]</span>
                                [[/isTopNotice]]
                              </td>
                              <td>
                                <div class="area">
                                                <!-- [D] 한 번 열람했던 글에 visited 클래스 추가해주세요 <a href="#" class="tit visited"> -->
                                  <a href="#" class="tit">
                                    [[#isReply]]
                                    <span class="comment"><span class="blind">답글</span></span><span>RE :</span>
                                    [[/isReply]]
                                    [[subject]]
                                    [[#isNew]]
                                    <span class="ico_new"><span class="blind">새글</span></span>
                                    [[/isNew]]
                                    [[#isSecret]]
                                    <span class="icon nicon_secret2"><span class="blind">비밀글</span></span>
                                    [[/isSecret]]
                                  </a>
                                </div>
                              </td>
                              <td><span class="writer">[[writeUser]]</span></td>
                              <td><span class="date">[[[regTmStr]]]</span></td>
                            </tr>
                          </script>
                          <!-- // template: 게시물 리스트형 목록 -->
                    
                          <!-- template: 게시물 카드형 목록 -->
                          <script type="text/html" data-template-name="cardMessage">
                            <div class="card_board _cardBoard [[#isTopNotice]]notice[[/isTopNotice]]">
                              [[^isReply]]
                              [[^isSecret]]
                              [[#hasImage]]
                                        <span class="thumb" data-message-no="[[messageNo]]" data-login-id="[[loginId]]" data-is-old-secret-reply="[[isOldSecretReply]]">
                                <img src="[[representImage]]" alt="이미지">
                                <!-- [[[moreImageCount]]] -->
                              </span>
                              [[/hasImage]]
                              [[/isSecret]]
                              [[/isReply]]
                    
                              <div class="info_area _infoArea" data-parent="1" data-message-no="[[messageNo]]" data-login-id="[[loginId]]" data-is-old-secret-reply="[[isOldSecretReply]]">
                                <a href="#" class="tit">
                    <input type="checkbox" class="_check" title="카드 선택">               [[#isReply]]<span class="comment"><span class="blind">답글</span></span><span>RE :</span>[[/isReply]]
                                  [[#isTopNotice]]<span class="icon nicon_sound3"><span class="blind">공지사항</span></span>[[/isTopNotice]]
                                  [[subject]]
                                  [[#isNew]]<span class="ico_new"><span class="blind">새글</span></span>[[/isNew]]
                                  [[#isSecret]]<span class="icon nicon_secret2"><span class="blind">비밀글</span></span>[[/isSecret]]
                                </a>
                                <a href="#" class="txt _clampText [[#isSecret]]secret_text[[/isSecret]]" data-clamp-line="[[clampLine]]">
                                  [[contentText]]
                                </a>
                                <div class="info">
                                  <span class="writer">[[writeUser]]</span>
                                  <span class="date">[[[regTmStr]]]</span>
                                </div>
                              </div>
                              [[#replies]]
                              <div class="info_area _infoArea [[className]]" data-message-no="[[messageNo]]" data-login-id="[[loginId]]" data-is-old-secret-reply="[[isOldSecretReply]]">
                                <a href="#" class="tit">
                    <input type="checkbox" class="_check" title="카드 선택">               [[#isReply]]
                                  <span class="comment"><span class="blind">답글</span></span><span>RE :</span>
                                  [[/isReply]]
                                  [[subject]]
                                  [[#isSecret]]
                                  <span class="icon nicon_secret2"><span class="blind">비밀글</span></span>
                                  [[/isSecret]]
                                  [[#isNew]]
                                  <span class="ico_new"><span class="blind">새글</span></span>
                                  [[/isNew]]
                                </a>
                                <a href="#" class="txt">
                                  [[contentText]]
                                </a>
                                <div class="info">
                                  <span class="writer">[[writeUser]]</span>
                                  <span class="date">[[[regTmStr]]]</span>
                                </div>
                              </div>
                              [[/replies]]
                            </div>
                    
                          </script>
                          <!-- // template: 게시물 카드형 목록 -->
                    
                          <!-- template: 게시물 매거진 목록 -->
                          <script type="text/html" data-template-name="mapMessage">
                    
                                </script>
                          <!-- // template: 게시물 매거진 목록 -->
                          <script>
                            mfarm.init(['mfarm.DataTable', 'mfarm.external.Mustache', 'mfarm.external.selectric', 'mfarm.external.clamp', "mfarm.external.eg"], function(dom, DataTable, Mustache, clamp) {
                    
                              'use strict';
                    
                              var $ = jQuery;
                              var boardConf = {"type":2,"viewType":"list","defaultText":"","nick":"\uad00\ub9ac\uc790","name":"\uacf5\uc9c0\uc0ac\ud56d","totalCount":"5"},
                                      nick = boardConf['nick'],
                                      cid = '4c92l851',
                                      isOwner = '1',
                                      loginId = 'mindflower2',
                                      mPage = '1',
                                      mQuery = decodeURIComponent(''),
                                      mQueryType = mfarm.util.unescapeHtml('0'),
                                      mMyList = '0',
                                      mCount, mListStart, mTotalCnt = boardConf['totalCount'],
                                      view, template, dataTable, publicObj,
                                      loginurl = 'https://www.modoo.at/home/oAuth/loginExternalNaver',
                                      infiniteGrid;
                    
                              function initialize() {
                                initSetting();
                                initView();
                                initTemplate();
                                initDataTable();
                                appendButtonToTitle();
                                attachEventHandler();
                    
                                var persist = false;
                                // for persist logic
                                if (boardConf.viewType == 'card' && $.persist.isNeeded()) {
                                  if ("scrollRestoration" in history) {
                                    history.scrollRestoration = "manual";
                                  }
                                  var persistData = $.persist("GRID_PERSIST");
                                  if (!$.isEmptyObject(persistData)) {
                                    persist = true;
                    
                                    view.button.deleteMessage.show();
                    
                                    infiniteGrid.setStatus(persistData.grid);
                                    window.scrollTo(0, persistData.scrollPos);
                                    mListStart = persistData.mListStart;
                    
                                    view.paging.empty().html(getPaginate(0, 0, mTotalCnt)); // currentPage, totalPage는 안넣어줘도 됨
                                  }
                                }
                    
                                if (!persist) {
                                  if (mMyList == 1 || mQuery != '') {
                                    getSearchMessage(mQueryType, mMyList);
                                  } else {
                                    getMessageList();
                                  }
                                }
                              }
                    
                              function finalize() { }
                    
                              function initSetting() {
                                if (mPage < 1) {
                                  mPage = 1;
                                }
                    
                                mCount = 8;
                    
                                if (boardConf.viewType == 'card') {
                                  mCount = 9;
                                }
                    
                                mListStart = (mPage - 1) * mCount + 1;
                    
                                if (mListStart > mTotalCnt) {
                                  mPage = parseInt((mTotalCnt - 1) / mCount) + 1;
                                  mListStart = (mPage - 1) * mCount + 1;
                                }
                    
                                if (boardConf.viewType == 'card') {
                    
                                  if (infiniteGrid) {
                                    infiniteGrid.clear();
                                    infiniteGrid.destroy();
                                  }
                    
                                  infiniteGrid = new eg.InfiniteGrid('#grid', {
                                    count: 0
                                  });
                    
                                }
                              }
                    
                              // [D] btnArea 추가했습니다.
                              function initView() {
                                view = {
                                  container: dom,
                                  mainTitle: $(".uio_title"),
                                  btnArea: $("._btnArea"),
                                  boardView: dom.find('[data-role="board_view"]'),
                                  boardList: dom.find('[data-role="board_list"]'),
                                  boardResultCount : $('[data-role="board_result_count"]'),
                                  search: {
                                    type: $('[data-role="select_result"]'),
                                    query: $('[data-role="txt_result"]'),
                                    close : $('._btnPrev'),
                                    input : $('._inputText'),
                                  },
                                  button: {
                                    search: $('._btnSearch'),
                                    write: null,
                                    deleteMessage: null,
                                    viewType: null
                                  },
                                  paging: dom.find('._paginate')
                                };
                                view.search.query.val(mQuery);
                    
                                $('select').selectric({inheritOriginalWidth: true});
                              }
                    
                              function initTemplate() {
                    
                                template = {};
                                dom.find('[data-template-name]').each(function() {
                                  template[this.getAttribute('data-template-name')] = (function(html) {
                                    var compiled = Mustache.compile(html);
                                    return function(jsonData) {
                                      if (!jsonData) {
                                        jsonData = {};
                                      }
                                      return compiled($.extend(jsonData, {
                                        isAdmin: function() {
                                          return this.admin === 1 ? true : false;
                                        },
                                        isReply: function() {
                                          return this.messageType === 2;
                                        },
                                        cmtCnt: function() {
                                          return this.commentCnt > 99 ? '99+' : this.commentCnt;
                                        },
                                        hasComment: function() {
                                          return this.commentCnt > 0;
                                        },
                                        isTopNotice: jsonData.topNotice === 1 ? true : false,
                                        className: function() {
                                          return (this.parentNo !== 0 ? 'comment' : '') + (this.topNotice === 1 ? ' notice' : '');
                                        },
                                        writeUser: function() {
                                          return this.admin === 1 && nick !== '' ? mfarm.util.unescapeHtml(nick) : this.writer;
                                        },
                                        regTmStr: function() {
                                          return mfarm.util.makeDate(this.regTm);
                                        },
                                        isSecret: function() {
                                          return this.secret === 1 ? true : false
                                        },
                                        isNew: function() {
                                          // 48시간 이내 등록된 경우 true, 관리자 확인 여부는 spec out
                                          return ((Date.now() / 1000 - this.regTm) / 3600) < 48;
                                        },
                                        images: function() {
                                          var images = [];
                                          if (this.image1) {
                                            images.push(this.image1);
                                          }
                                          if (this.image2) {
                                            images.push(this.image2);
                                          }
                                          if (this.image3) {
                                            images.push(this.image3);
                                          }
                                          if (this.image4) {
                                            images.push(this.image4);
                                          }
                                          if (this.image5) {
                                            images.push(this.image5);
                                          }
                                          return images;
                                        },
                                        hasImage: function() {
                                          return this.images().length > 0;
                                        },
                                        representImage: function() {
                                          if (boardConf.viewType == 'card') {
                                            return this.image1 + "?type=f353_353";
                                          }
                    
                                          return this.image1 + "?type=f70_50";
                                        },
                                        moreImageCount: function() {
                                          if (this.images().length == 1) {
                                            return "";
                                          }
                    
                                          return "<span href=\"#\" class=\"num\">" + (this.images().length) + "</span>";
                                        },
                                        clampLine: function() {
                                          return this.images().length > 0 ? 4 : 7;
                                        },
                                        contentText: function() {
                                          var content = $('<div>').html(this['content']).text();
                    
                                          if (content == 'Secret Message') {
                                            content = '비밀글입니다';
                                          }
                    
                                          return content.substring(0, 300);
                                        }
                                      }));
                                    };
                                  })(this.innerHTML.trim());
                                });
                              }
                    
                              function initDataTable() {
                    
                                dataTable = new DataTable();
                    
                                dataTable.addColumn('string', 'cid', 'cid');
                                dataTable.addColumn('number', 'messageClass', 'messageClass');
                                dataTable.addColumn('string', 'ownerId', 'ownerId');
                                dataTable.addColumn('number', 'messageNo', 'messageNo');
                                dataTable.addColumn('number', 'parentNo', 'parentNo');
                                dataTable.addColumn('number', 'messageType', 'messageType');
                                dataTable.addColumn('number', 'secret', 'secret');
                                dataTable.addColumn('number', 'admin', 'admin');
                                dataTable.addColumn('number', 'hasExtraInfo', 'hasExtraInfo');
                                dataTable.addColumn('string', 'loginId', 'loginId');
                                dataTable.addColumn('string', 'writer', 'writer');
                                dataTable.addColumn('string', 'subject', 'subject');
                                dataTable.addColumn('string', 'content', 'content');
                                dataTable.addColumn('number', 'replyCnt', 'replyCnt');
                                dataTable.addColumn('number', 'commentCnt', 'commentCnt');
                                dataTable.addColumn('number', 'hasImage', 'hasImage');
                                dataTable.addColumn('string', 'image1', 'image1');
                                dataTable.addColumn('string', 'image2', 'image2');
                                dataTable.addColumn('string', 'image3', 'image3');
                                dataTable.addColumn('string', 'image4', 'image4');
                                dataTable.addColumn('string', 'image5', 'image5');
                                dataTable.addColumn('object', 'regTm', 'regTm');
                                dataTable.addColumn('object', 'editTm', 'editTm');
                                dataTable.addColumn('object', 'delTm', 'delTm');
                                dataTable.addColumn('number', 'totalCnt', 'totalCnt');
                                dataTable.addColumn('number', 'topNotice', 'topNotice');
                                dataTable.addColumn('number', 'adminRead', 'adminRead');
                                dataTable.addColumn('number', 'isOldSecretReply', 'isOldSecretReply');
                              }
                    
                              function appendButtonToTitle() {
                                view.mainTitle.append(template.boardButtonForExternalDom);
                                view.button.write = view.btnArea.find('._write');
                                view.button.deleteMessage = view.btnArea.find('._deleteMessage');
                                view.button.viewType = view.mainTitle.find('._viewType');
                              }
                    
                              function attachEventHandler() {
                                view.boardList.delegate('._checkAll', 'click', function(e) {
                                  view.boardList.find('input._check').prop('checked',$(this).prop('checked'));
                                });
                    
                                view.boardList.delegate('._check', 'click', function(e) {
                                  e.stopPropagation();
                                });
                    
                                // 게시물 보기
                                view.boardView.delegate('[data-message-no]', 'click', function(e) {
                                  var that = $(this);
                                  var welTarget = $(e.target);
                    
                                  if (welTarget.is(':checkbox')) {
                                    return true;
                                  } else if (welTarget.find(':checkbox').length > 0) {
                                    var checkBoxes = welTarget.find(':checkbox');
                                    checkBoxes.prop("checked", !checkBoxes.prop("checked"));
                                    return false;
                                  }
                    
                                  e.preventDefault();
                    
                                  var url = mfarm.util.updateURLParameter(window.location.href, 'messageNo', that.attr('data-message-no'));
                                  url = mfarm.util.updateURLParameter(url, 'mode', 'view');
                    
                                  if ($(this).hasClass('notice')) {
                                    url = mfarm.util.updateURLParameter(url, 'topNotice', '1');
                                  }
                                  var val;
                    
                                  val = {
                                    mode: $.trim(view.search.type.val()),
                                    keyword: $.trim(view.search.query.val()),
                                  };
                    
                                  if (val.keyword === '') {
                                    val.mode = 0;
                                  }
                    
                                  url = mfarm.util.updateURLParameter(url, 'query', val.keyword);
                                  url = mfarm.util.updateURLParameter(url, 'queryType', val.mode);
                                  url = mfarm.util.updateURLParameter(url, 'myList', mMyList);
                                  url = mfarm.util.updateURLParameter(url, 'page', mPage);
                    
                                  var messageLoginId = that.attr('data-login-id');
                                  var isOldSecretReply = that.attr('data-is-old-secret-reply');
                    
                                  var isOldMessage = messageLoginId == '' || messageLoginId.indexOf('::') > -1 || isOldSecretReply == 1;
                    
                                  if (boardConf.viewType == 'card') {
                                    $.persist("GRID_PERSIST", {
                                      "scrollPos": $(document).scrollTop(),
                                      "grid": infiniteGrid.getStatus(),
                                      "mListStart": mListStart
                                    });
                                  }
                    
                                  if (that.find('.secret').length > 0 && !isOldMessage && loginId == '') {
                                    location.href = loginurl + '?returnUrl=' + encodeURIComponent(url);
                                  } else {
                                    location.href = url;
                                  }
                    
                                });
                    
                                // 게시물 작성
                                view.button.write.bind('click', function(e) {
                                  if (checkPreviewWrite('미리보기에서는 글을 작성 할 수 없습니다.')) {
                                    return false;
                                  }
                    
                                  var url = mfarm.util.updateURLParameter(window.location.href, 'mode', 'write');
                                  url = mfarm.util.updateURLParameter(url, 'messageNo', '', true);
                                  url = mfarm.util.updateURLParameter(url, 'parentNo', '', true);
                    
                                  if (loginId == '') {
                                    location.href = loginurl + '?returnUrl=' + encodeURIComponent(url);
                                  } else {
                                    location.href = url;
                                  }
                    
                                });
                    
                                // 선택된 글 삭제
                                view.button.deleteMessage.on("click", function(e) {
                                  var checkedboxes = view.container.find(":checkbox:checked");
                                  var deleteCount = 0;
                    
                                  if (checkedboxes.length == 0) {
                                    alert("삭제할 글을 선택해 주세요");
                                    return false;
                                  }
                    
                                  if (confirm("게시글을 삭제하면 게시글 하위의 답글과 댓글이 모두 삭제됩니다. 삭제하시겠습니까?") == false) {
                                    return false;
                                  }
                    
                                  checkedboxes.each(function(index, item) {
                                    var wel = $(item).closest("[data-message-no]");
                                    var messageNo = wel.attr("data-message-no");
                    
                                    if (!messageNo) {
                                      return true;
                                    }
                    
                                    $.ajax({
                                      type: 'POST',
                                      url: '/apps/board/DeleteMessage.json',
                                      data: {
                                        'cid': cid,
                                        'messageNo': messageNo,
                                        'password': '',
                                        'admin': 1
                                      },
                                      async: false,
                                      success: function(ret) {
                                        if (ret.retCode === 0) {
                                          deleteCount++;
                    
                                          if (wel.attr('data-parent') == 1) {
                                            wel.closest("._cardBoard").remove();
                                          } else {
                                            wel.remove();
                                          }
                    
                                        } else {
                                          alert(messageNo + "번 글 삭제가 실패하였습니다.");
                                        }
                                      }
                                    });
                                  });
                    
                                  view.container.find(":checkbox:checked").prop("checked", false);
                                  alert("선택한 글을 모두 삭제하였습니다.");
                    
                                  mListStart -= deleteCount;
                                  mTotalCnt -= deleteCount;
                    
                                  initSetting();
                    
                                  if (mMyList == 1 || mQuery != '') {
                                    getSearchMessage(mQueryType, mMyList);
                                  } else {
                                    getMessageList();
                                  }
                                });
                    
                                // 페이징
                                view.paging.delegate('a', 'click', function(event) {
                                  event.stopPropagation();
                                  var current = $(event.currentTarget);
                                  var currentPage = parseInt(view.paging.find('.selected').html());
                                  var page = mPage;
                    
                                  if (current.hasClass('_more')) { // 더보기
                    
                                    mListStart += mCount;
                                    if (mMyList == 1 || mQuery != '') {
                                      getSearchMessage(mQueryType, mMyList);
                                    } else {
                                      getMessageList();
                                    }
                    
                                    return false;
                                  } else if (current.hasClass('_prev')) { // 이전
                                    if (currentPage - 10 < 1) {
                                      page = 1;
                                    } else {
                                      page = currentPage - 10;
                                    }
                    
                                  } else if (current.hasClass('_next')) { // 다음
                                    if (currentPage + 10 > parseInt((mTotalCnt - 1) / mCount) + 1) {
                                      page = parseInt((mTotalCnt - 1) / mCount) + 1;
                                    } else {
                                      page = currentPage + 10;
                                    }
                                  } else { // 숫자
                                    page = parseInt(current.html());
                                    if (currentPage == page) {
                                      return false;
                                    }
                                  }
                    
                                  location.href = mfarm.util.updateURLParameter(window.location.href, 'page', page);
                                  return false;
                                });
                    
                                view.search.close.bind('click', function(e) {
                                  location.href = '?link=' + cid + '&viewType=' + boardConf.viewType;
                                  return false;
                                });
                    
                                // 엔터로 검색
                                view.search.query.bind('keyup', function(e) {
                                  if (e.keyCode == 13) {
                                    view.button.search.trigger('click');
                                  }
                                });
                    
                                // 검색
                                view.button.search.bind('click', function(e) {
                                  e.preventDefault();
                    
                                  var val;
                    
                                  val = {
                                    mode: $.trim(view.search.type.val()),
                                    keyword: $.trim(view.search.query.val()),
                                  };
                    
                                  if (val.keyword === '') {
                                    alert('검색어를 입력하세요.');
                                    view.search.input.focus();
                                    return false;
                                  }
                    
                                  var url = mfarm.util.updateURLParameter(window.location.href, 'query', val.keyword);
                                  url = mfarm.util.updateURLParameter(url, 'queryType', val.mode);
                                  url = mfarm.util.updateURLParameter(url, 'page', 1);
                                  location.href = url;
                                });
                    
                                // 내글보기/ 전체글보기
                                view.btnArea.find('._filter').on('click', function(e) {
                                  var that = $(this), url;
                    
                                  if (that.hasClass('_all')) { // 전체 보기
                                    location.href = '?link=' + cid + "&viewType=" + boardConf.viewType;
                                  } else {
                                    url = mfarm.util.updateURLParameter(window.location.href, 'query', '', true);
                                    url = mfarm.util.updateURLParameter(url, 'myList', 1);
                                    url = mfarm.util.updateURLParameter(url, 'page', 1);
                                    url = mfarm.util.updateURLParameter(url, 'queryType', 1, true);
                                    url = mfarm.util.updateURLParameter(url, 'query', '', true);
                    
                                    if (loginId == '') {
                                      location.href = loginurl + '?returnUrl=' + encodeURIComponent(url);
                                    } else {
                                      location.href = url;
                                    }
                                  }
                                });
                    
                                // 카드형 / 목록형 보기
                                view.button.viewType.on('click', 'a', function(event) {
                                  var url = mfarm.util.updateURLParameter(window.location.href, 'page', 1);
                                  url = mfarm.util.updateURLParameter(url, 'viewType', this.getAttribute('data-type'));
                    
                                  location.href = url;
                                });
                              }
                    
                              // 글 리스트데이터 가져오기
                              function getMessageList() {
                                if (mTotalCnt > 0 && mTotalCnt < mListStart) {
                                  return;
                                }
                    
                                $.ajax({
                                          url: '/apps/board/GetMessageList.json',
                                          type: 'post',
                                          data: {
                                            cid: cid,
                                            startNo: mListStart,
                                            count: mCount,
                                            searchMode: 0,
                                            replyAttr: 1
                                        },
                                        dataType: 'json',
                                        async: false,
                                        success: function(ret) {
                                  if (ret.messageList.length != 0) {
                                    mTotalCnt = ret.messageList[0].totalCnt;
                                  }
                                  dataTable.removeRows();
                                  dataTable.addRows(ret.messageList);
                                  renderMessageList();
                                },
                                error: function(ret) {
                                  alert(ret.retMsg);
                                }
                              });
                              }
                    
                              // 글리스트 rending
                              function renderMessageList() {
                                view.boardResultCount.css('display', 'none');
                                if (dataTable.getNumberOfRows() == 0 && mTotalCnt < 1) {
                                  view.button.deleteMessage.hide();
                                  view.boardList.addClass('nodata_area').find('._boardContent').html(template[boardConf.viewType + 'NoData']);
                                  view.paging.html(getPaginate(0, 1, 1));
                                  return false;
                                }
                                renderList();
                              }
                    
                              function getPaginate(currentPage, totalPage, totalCount) {
                                var pageHTML = [];
                                var currentCount = (mListStart - 1 + mCount);
                                var startPage = parseInt((currentPage - 1) / 10, 10) * 10 + 1;
                                var endPage = startPage + 9 > totalPage ? totalPage : startPage + 9;
                    
                                if (boardConf.viewType != 'card') {
                                  pageHTML.push('<a href="#" class="prev _prev"><span class="icon nicon_backward2"><span class="blind">이전</span></span></a>');
                    
                                  for (var i = startPage; i < endPage + 1; i++) {
                                    pageHTML.push('<a href="#"' + (i == currentPage ? 'class="selected"' : '') + '>' + i + '</a>');
                                  }
                                  pageHTML.push('<a href="#" class="next _next"><span class="icon nicon_forward2"><span class="blind">다음</span></span></a>');
                                } else {
                                  if (currentCount >= totalCount) {
                                    view.paging.hide();
                                    return '';
                                  }
                    
                                  pageHTML.push('<a href="#" class="btn_more _more">');
                                  pageHTML.push('더보기<span class="total">' + currentCount + '/' + totalCount + '</span><span class="icon nicon_down2"><span class="blind">펼치기</span></span>');
                                  pageHTML.push('</a>');
                                }
                    
                                view.paging.show();
                                return pageHTML.join('');
                              }
                    
                              // 글 검색
                              function getSearchMessage(type, myList) {
                                if (mTotalCnt > 0 && mTotalCnt < mListStart) {
                                  return;
                                }
                    
                                if (myList && myList == 1) {
                                  if (loginId == '') {
                                    location.href = loginurl + '?returnUrl=' + encodeURIComponent(location.href);
                                    return;
                                  }
                                }
                    
                                var val = {
                                  mode: $.trim(view.search.type.val()),
                                  keyword: $.trim(view.search.query.val()),
                                };
                    
                                if (!(myList && myList == 1) && val.keyword === '') {
                                  alert('검색어를 입력하세요.');
                                  el.keyword.focus();
                                  return false;
                                }
                    
                                if (val.mode == 1 && val.keyword == nick) {
                                  val.mode = 4;
                                }
                    
                                $.post('/apps/board/GetMessageList.json', {
                                  cid: cid,
                                  startNo: mListStart,
                                  count: mCount,
                                  searchMyList: mMyList,
                                  searchMode: val.mode,
                                  searchWord: val.keyword,
                                  replyAttr: 1
                              }, function(ret) {
                                  if (ret.retCode === 0) {
                                    dataTable.removeRows();
                                    dataTable.addRows(ret.messageList);
                                    if (ret.messageList.length > 0) {
                                      mTotalCnt = ret.messageList[0].totalCnt;
                                    } else {
                                      mTotalCnt = 0;
                                    }
                    
                                    renderSearchList(val.keyword);
                                  } else {
                                    alert(ret.retMsg);
                                  }
                                }, 'json');
                              }
                    
                              function renderList() {
                                var trHTML = [], replies = {}, filteredRows, inx, jnx, each, tmp;
                    
                                // 답글들 정리
                                filteredRows = dataTable.getFilteredRows(function() {
                                  return this.parentNo > 0 ? true : false;
                                });
                    
                                for (inx = 0; inx < filteredRows.length; inx++) {
                                  each = dataTable.getRow(filteredRows[inx]);
                                  if (!replies[each.parentNo]) {
                                    replies[each.parentNo] = [];
                                  }
                                  replies[each.parentNo].push(each);
                                }
                    
                                // 부모글을 중심으로 리스트 생성
                                filteredRows = dataTable.getFilteredRows(function() {
                                  return this.parentNo == 0 ? true : false;
                                });
                    
                                var templateMessage = template.listMessage;
                                if (boardConf.viewType == 'card') {
                                  templateMessage = template.cardMessage;
                                }
                    
                                for (inx = 0; inx < filteredRows.length; inx++) {
                                  each = dataTable.getRow(filteredRows[inx]);
                                  if (each.topNotice != 1) {
                                    each['replies'] = replies[each.messageNo];
                                  }
                                  tmp = [];
                                  tmp.push(templateMessage(each));
                    
                                  if (replies[each.messageNo] && each.topNotice != 1) {
                                    if (boardConf.viewType != 'card') {
                                      for (jnx = 0; jnx < replies[each.messageNo].length; jnx++) {
                                        tmp.push(templateMessage($.extend(replies[each.messageNo][jnx], {
                                          parentMessageType: each.messageType
                                        })));
                                      }
                                    }
                    
                                    delete replies[each.messageNo];
                                  }
                                  trHTML.push(tmp.join(''));
                                }
                    
                                tmp = [];
                                for (var key in replies) {
                                  var reply = replies[key];
                                  var firstReply = reply.shift();
                                  firstReply['replies'] = reply;
                    
                                  tmp.push(templateMessage(firstReply));
                    
                                  if (boardConf.viewType != 'card') {
                                    for (jnx = 0; jnx < reply.length; jnx++) {
                                      tmp.push(templateMessage(reply[jnx]));
                                    }
                                  }
                                }
                    
                                if (tmp.length > 0) {
                                  trHTML.unshift(tmp.join(''));
                                }
                    
                                if (boardConf.viewType != 'card') {
                                  view.boardList.find('._boardContent').html(trHTML.join(''));
                                } else {
                                  infiniteGrid.append(trHTML.join(''));
                                  $.each(view.boardList.find("._clampText"), function(index, value) {
                                    if (value.getAttribute("data-done-clamp") == "true") {
                                      return true;
                                    }
                    
                                    $clamp(value, {
                                      clamp: value.getAttribute("data-clamp-line")
                                    });
                                    value.setAttribute("data-done-clamp", "true");
                                  });
                                }
                    
                                var currentPage = parseInt((mListStart - 1) / mCount, 10) + 1;
                                var totalPage = parseInt((each.totalCnt - 1) / mCount, 10) + 1;
                                // 페이징 처리
                                view.paging.html(getPaginate(currentPage, totalPage, each.totalCnt));
                              }
                    
                              // 검색결과 rending
                              function renderSearchList(query) {
                                var templateMessage = (boardConf.viewType == 'card') ? template.cardMessage : template.listMessage;
                    
                                if (dataTable.getNumberOfRows() == 0 && mTotalCnt == 0) {
                                  if (mMyList != 1) {
                                    view.button.deleteMessage.hide();
                                  } else {
                                    view.button.deleteMessage.show();
                                  }
                    
                                  var oBoardContent = view.boardList.addClass('nodata_area').find('._boardContent');
                                  if (mMyList == 1 && query == "") {
                                    oBoardContent.html(template[boardConf.viewType + 'NoData']);
                                  } else {
                                    oBoardContent.html(template[boardConf.viewType + 'NoSearchData']);
                                    oBoardContent.find('._keyword').text(mQuery);
                                  }
                    
                                  renderSearchResult(mMyList, mQuery, mTotalCnt);
                                  view.paging.html(getPaginate(0, 1, 1));
                    
                                } else {
                                  view.button.deleteMessage.show();
                                  renderSearchResult(mMyList, mQuery, mTotalCnt);
                                  renderList();
                                }
                              }
                    
                              function renderSearchResult() {
                                if (mMyList != 1 || mQuery !== '') {
                                  view.boardResultCount.find('._keyword').text(mQuery);
                                  view.boardResultCount.find('._myList').hide();
                                  view.boardResultCount.find('._searchList').show();
                                } else {
                                  view.boardResultCount.find('._searchList').hide();
                                  view.boardResultCount.find('._myList').show();
                                }
                    
                                view.boardResultCount.find('[data-role="result_cnt"]').html(mTotalCnt);
                                view.boardResultCount.css('display', 'inline-block');
                              }
                    
                              function checkPreviewWrite(message) {
                                if (ENV.preview == 1 && message) {
                                  alert(message);
                                  return true;
                                }
                    
                                return false;
                              }
                    
                              initialize();
                    
                              return publicObj;
                            });
                          </script>
                    
                        </div>
                    
                        <div class="btn_area _btnArea">
                          <div class="side_area">
                            <a href="#" class="btn write _write theme_background theme_border">글쓰기</a>
                          </div>
                                <a href="#" class="btn delete _deleteMessage">선택삭제</a>
                        </div>
                    
                        <div class="search_area">
                          <div class="list_srch">
                                    <span class="sorting">
                                        <div class="selectric-wrapper" style="width: 95px;"><div class="selectric-hide-select"><select data-role="select_result" tabindex="0">
                                <option value="2">제목</option>
                                <option value="3">내용</option>
                              </select></div><div class="selectric"><p class="label">제목</p><span class="button"><span class="blind">시간 설정 열기</span></span></div><div class="selectric-items" tabindex="-1"><div class="selectric-scroll"><ul><li data-index="0" class="selected">제목</li><li data-index="1" class="last">내용</li></ul></div></div><input class="selectric-input" tabindex="0"></div>
                                    </span>
                            <input type="text" data-role="txt_result" class="input_txt _inputText" placeholder="검색어를 입력하세요">
                            <a href="#" class="btn_srch _btnSearch">검색</a>
                          </div>
                        </div>
                      </div>
                    </div>
                </div> 
            </div>
        </div>
    </div>
</div>
  